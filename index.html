<!DOCTYPE html>
<html>
<head>
    <title>Narrative Systems Engine v40</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #0f0f0f; color: #e0e0e0; display: flex; height: 100vh; overflow: hidden; }
        #main-wrapper { display: flex; flex-grow: 1; flex-direction: column; position: relative; }
        #cy { flex-grow: 1; background: #0f0f0f; }
        #registry-panel { width: 420px; background: #151515; border-left: 1px solid #333; padding: 20px; overflow-y: auto; }
        .registry-item { background: #222; padding: 15px; border-radius: 8px; margin-top: 10px; border-left: 4px solid #00d4ff; cursor: pointer; transition: 0.2s; }
        .registry-item.active-lens { border-left-color: #fff; background: #005f73; box-shadow: 0 0 15px #00d4ff; }
        
        .custom-modal { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1a1a1a; border: 2px solid #00d4ff; border-radius: 12px; padding: 25px; display: none; z-index: 3000; box-shadow: 0 0 60px #000; width: 450px; }
        #inspector-popup { width: 850px; z-index: 2000; }
        
        .pop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .controls { position: absolute; top: 15px; left: 15px; z-index: 999; background: #1a1a1a; padding: 10px; border-radius: 8px; border: 1px solid #333; }
        button { cursor: pointer; padding: 6px 12px; margin: 2px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px; font-size: 11px; }
        input, textarea, select { background: #222; border: 1px solid #444; color: #fff; width: 100%; padding: 8px; margin-top: 5px; border-radius: 4px; font-family: inherit; }
        label { font-size: 10px; color: #888; text-transform: uppercase; font-weight: bold; display: block; margin-top: 12px; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; z-index: 1000; }
        .lexical-row { display: flex; gap: 5px; align-items: center; }
    </style>
</head>
<body>

<div class="overlay" onclick="closeAllModals()"></div>

<div id="connector-modal" class="custom-modal">
    <h3 style="color:#00d4ff; margin:0 0 15px 0;">Connector Action</h3>
    <button onclick="triggerRename()" style="width:100%; padding:12px; margin-bottom:8px;">âœŽ Rename Label</button>
    <button onclick="handleConnectorChoice('N')" style="width:100%; padding:12px; margin-bottom:8px;">+ Add Complication Node</button>
    <button onclick="handleConnectorChoice('F')" style="width:100%; padding:12px;">+ Add Friction Node</button>
</div>

<div id="prompt-modal" class="custom-modal">
    <h3 id="modal-title" style="color:#00d4ff; margin:0;">Input</h3>
    <input id="modal-input">
    <div style="margin-top:20px; display:flex; justify-content: space-between;">
        <button id="modal-confirm" style="background:#005f73; width:48%;">Confirm</button>
        <button onclick="closeAllModals()" style="width:48%;">Cancel</button>
    </div>
</div>

<div id="main-wrapper">
    <div class="controls">
        <button onclick="addNode()">+ New Scene</button>
        <button onclick="cy.fit(null, 50)">Auto-Zoom</button>
        <button onclick="exportDeep()">Export JSON</button>
        <button onclick="document.getElementById('importFile').click()">Import JSON</button>
        <input type="file" id="importFile" style="display:none" onchange="importDeep(event)">
        <button onclick="clearHighlights()" style="background:#600; border-color:#f00;">RESET VIEW</button>
    </div>
    <div id="cy"></div>

    <div id="inspector-popup" class="custom-modal">
        <h3 style="margin: 0 0 15px 0; color: #00d4ff;">SCENE FOCUS</h3>
        <div class="pop-grid">
            <div>
                <label>Scene Label</label><input id="p-label">
                <label>Emotional Score (-10 to 10)</label><input type="number" id="p-score">
                <label>Characters</label><input id="p-char">
                <label>Settings</label><input id="p-set">
            </div>
            <div>
                <label>Action Family</label>
                <div class="lexical-row">
                    <select id="p-action-cat" onchange="updateSubList('action', this.value)"></select>
                    <select id="p-action-word" onchange="document.getElementById('p-action-val').value=this.value"></select>
                </div>
                <input id="p-action-val">
                <label>Emotions Family</label>
                <div class="lexical-row">
                    <select id="p-emotions-cat" onchange="updateSubList('emotions', this.value)"></select>
                    <select id="p-emotions-word" onchange="document.getElementById('p-emotions-val').value=this.value"></select>
                </div>
                <input id="p-emotions-val">
                <label>Immersion</label>
                <div class="lexical-row">
                    <select id="p-immersion-cat" onchange="updateSubList('immersion', this.value)"></select>
                    <select id="p-immersion-word" onchange="document.getElementById('p-immersion-val').value=this.value"></select>
                </div>
                <input id="p-immersion-val">
                <label>Utility</label>
                <div class="lexical-row">
                    <select id="p-utility-cat" onchange="updateSubList('utility', this.value)"></select>
                    <select id="p-utility-word" onchange="document.getElementById('p-utility-val').value=this.value"></select>
                </div>
                <input id="p-utility-val">
            </div>
        </div>
        <button style="margin-top: 25px; width: 100%; padding: 12px; background: #005f73; border:none; color:white; font-weight:bold;" onclick="saveAndClose()">Save & Exit</button>
    </div>
</div>

<div id="registry-panel"><h3 style="color:#00d4ff; margin:0 0 10px 0;">World Registry</h3><div id="registry-content"></div></div>

<script>
    let activeNode = null, sourceNode = null, activeEdge = null, registry = { characters: {}, settings: {} };
    let lensMode = { type: null, name: null };
    const Y_SCALE = 60;

    const banks = {
        action: { "Conflict": ["Confronts", "Attacks", "Sabotages"], "Subterfuge": ["Betrays", "Deceives", "Infiltrates"], "Social": ["Negotiates", "Confesses", "Persuades"] },
        emotions: { "High": ["Euphoria", "Terror", "Rage"], "Low": ["Melancholy", "Dread", "Despair"], "Internal": ["Nostalgia", "Hope", "Shame"] },
        utility: { "Structural": ["Inciting Incident", "Midpoint Pivot", "Resolution"], "Developmental": ["Character Intro", "Thematic Setup", "World Building"] },
        immersion: { "Sensory": ["Sulphurous", "Rot-sweet", "Iron-tanged"], "Visual": ["Neon-soaked", "Bleached", "Luminous"] }
    };

    var cy = cytoscape({
        container: document.getElementById('cy'),
        style: [
            { selector: 'node', style: { 'label': 'data(label)', 'background-color': 'data(color)', 'color': '#fff', 'text-valign': 'center', 'width': 80, 'height': 80, 'font-size': '10px', 'shape': 'ellipse', 'text-wrap': 'wrap' }},
            { selector: 'node[type="friction"]', style: { 'width': 35, 'height': 35, 'background-color': '#ff4500', 'shape': 'diamond', 'label': 'data(label)', 'color': '#ff4500', 'text-valign': 'top' }},
            { selector: 'edge', style: { 'width': 4, 'line-color': '#333', 'target-arrow-shape': 'triangle', 'label': 'data(action)', 'color': '#00d4ff', 'curve-style': 'bezier', 'font-size': '11px', 'text-background-opacity': 1, 'text-background-color': '#0f0f0f' }},
            { selector: '.ghost', style: { 'opacity': 0.02, 'text-opacity': 0 }},
            { selector: '.lens-highlight', style: { 'border-width': 8, 'border-color': '#00d4ff', 'line-color': '#00d4ff', 'width': 8, 'opacity': 1, 'text-opacity': 1 }}
        ]
    });

    // DEFAULT STARTUP ARC
    window.onload = function() {
        const h = window.innerHeight / 2;
        cy.add([
            { group: 'nodes', data: { id: 'start', label: 'Beginning', score: -2, color: nPos(-2), characters: ['Alpha'], settings: ['Base'] }, position: { x: 100, y: h - (-2 * Y_SCALE) } },
            { group: 'nodes', data: { id: 'mid', label: 'Complication', score: -8, color: nPos(-8), characters: ['Alpha'], settings: ['Base'] }, position: { x: 350, y: h - (-8 * Y_SCALE) } },
            { group: 'nodes', data: { id: 'end', label: 'End', score: 8, color: nPos(8), characters: ['Alpha'], settings: ['Base'] }, position: { x: 600, y: h - (8 * Y_SCALE) } },
            { group: 'edges', data: { source: 'start', target: 'mid', action: 'Wants' } },
            { group: 'edges', data: { source: 'mid', target: 'end', action: 'Overcomes' } }
        ]);
        registry.characters['Alpha'] = { h1: '', h2: '', desc: '' };
        registry.settings['Base'] = { h1: '', h2: '', desc: '' };
        refreshRegistry();
        cy.fit(null, 50);
    };

    function populateCategories() {
        ['action', 'emotions', 'utility', 'immersion'].forEach(key => {
            const catSelect = document.getElementById(`p-${key}-cat`);
            catSelect.innerHTML = '<option value="">Family...</option>';
            Object.keys(banks[key]).forEach(cat => {
                let opt = document.createElement('option');
                opt.value = cat; opt.innerText = cat; catSelect.appendChild(opt);
            });
        });
    }

    function updateSubList(key, category) {
        const wordSelect = document.getElementById(`p-${key}-word`);
        wordSelect.innerHTML = '<option value="">Word...</option>';
        if (!category) return;
        banks[key][category].forEach(word => {
            let opt = document.createElement('option');
            opt.value = word; opt.innerText = word; wordSelect.appendChild(opt);
        });
    }

    function showCustomPrompt(title, placeholder, callback) {
        document.querySelector('.overlay').style.display = 'block';
        const modal = document.getElementById('prompt-modal');
        modal.style.display = 'block';
        document.getElementById('modal-title').innerText = title;
        const input = document.getElementById('modal-input');
        input.value = ''; input.placeholder = placeholder;
        document.getElementById('modal-confirm').onclick = () => { callback(input.value); closeAllModals(); };
    }

    function addNode() {
        const id = 'n' + Date.now();
        cy.add({ group: 'nodes', data: { id: id, label: "New Scene", score: 0, color: '#444', characters: [], settings: [] }, position: { x: (cy.nodes().filter('[type!="friction"]').length * 220) + 100, y: window.innerHeight/2 } });
    }

    cy.on('tap', 'node', function(evt){
        let n = evt.target;
        if (n.data('type') === 'friction') return;
        if (!sourceNode) { sourceNode = n; n.style({'border-width': 6, 'border-color': '#fff'}); } 
        else {
            if (sourceNode.id() === n.id()) { openInspector(n); } 
            else {
                const s = sourceNode;
                showCustomPrompt("Connection Label", "Action...", (val) => {
                    if (val) cy.add({ group: 'edges', data: { source: s.id(), target: n.id(), action: val } });
                });
            }
            sourceNode.style({'border-width': 0}); sourceNode = null;
        }
    });

    cy.on('tap', 'edge', function(evt){
        activeEdge = evt.target;
        document.querySelector('.overlay').style.display = 'block';
        document.getElementById('connector-modal').style.display = 'block';
    });

    function handleConnectorChoice(choice) {
        const edge = activeEdge; const sNode = edge.source(); const tNode = edge.target(); const originalAction = edge.data('action');
        const midX = (sNode.position().x + tNode.position().x) / 2;
        const midY = (sNode.position().y + tNode.position().y) / 2;

        if (choice === 'F') {
            showCustomPrompt("Friction Label", "Conflict...", (fLab) => {
                const frictionId = 'f' + Date.now();
                cy.remove(edge);
                cy.add({ group: 'nodes', data: { id: frictionId, type: "friction", label: fLab || "PIN", characters: [], settings: [] }, position: { x: midX, y: midY } });
                cy.add([{ group: 'edges', data: { source: sNode.id(), target: frictionId, action: "friction" } },{ group: 'edges', data: { source: frictionId, target: tNode.id(), action: originalAction } }]);
            });
        } else if (choice === 'N') {
            const midId = 'n' + Date.now();
            cy.remove(edge);
            cy.add({ group: 'nodes', data: { id: midId, label: "Complication", score: 0, color: '#444', characters: [], settings: [] }, position: { x: midX, y: midY } });
            cy.add([{ group: 'edges', data: { source: sNode.id(), target: midId, action: "leads to" } }, { group: 'edges', data: { source: midId, target: tNode.id(), action: originalAction } }]);
        }
        closeAllModals(); refreshRegistry();
    }

    function triggerRename() { showCustomPrompt("Rename Label", "Label...", (val) => { if(val) activeEdge.data('action', val); }); }

    function openInspector(n) {
        activeNode = n; const d = n.data(); populateCategories();
        document.getElementById('inspector-popup').style.display = 'block';
        document.querySelector('.overlay').style.display = 'block';
        ['label', 'score'].forEach(f => document.getElementById('p-'+f).value = d[f] || (f==='score'?0:''));
        ['action', 'emotions', 'immersion', 'utility'].forEach(f => document.getElementById('p-'+f+'-val').value = d[f] || '');
        document.getElementById('p-char').value = (d.characters || []).join(', ');
        document.getElementById('p-set').value = (d.settings || []).join(', ');
    }

    function saveAndClose() {
        if (!activeNode) return;
        const score = document.getElementById('p-score').value;
        const chars = document.getElementById('p-char').value.split(',').map(s=>s.trim()).filter(s=>s);
        const sets = document.getElementById('p-set').value.split(',').map(s=>s.trim()).filter(s=>s);
        activeNode.data({ label: document.getElementById('p-label').value, score: score, characters: chars, settings: sets, action: document.getElementById('p-action-val').value, emotions: document.getElementById('p-emotions-val').value, immersion: document.getElementById('p-immersion-val').value, utility: document.getElementById('p-utility-val').value, color: nPos(score) });
        activeNode.position('y', (window.innerHeight/2) - (score * Y_SCALE));
        chars.forEach(c => { if(!registry.characters[c]) registry.characters[c] = { h1: '', h2: '', desc: '' }; });
        sets.forEach(s => { if(!registry.settings[s]) registry.settings[s] = { h1: '', h2: '', desc: '' }; });
        refreshRegistry(); closeAllModals();
        if(lensMode.name) applyLens(lensMode.type, lensMode.name);
    }

    function applyLens(type, name) {
        lensMode = { type: type, name: name }; const dataKey = type === 'characters' ? 'characters' : 'settings'; const targetName = name.trim().toLowerCase();
        cy.elements().removeClass('lens-highlight').addClass('ghost');
        const matches = cy.nodes().filter(n => { const list = n.data(dataKey) || []; return list.some(item => item.trim().toLowerCase() === targetName); });
        matches.removeClass('ghost').addClass('lens-highlight');
        cy.edges().forEach(e => { const sList = e.source().data(dataKey) || []; const tList = e.target().data(dataKey) || []; if (sList.some(i => i.trim().toLowerCase() === targetName) && tList.some(i => i.trim().toLowerCase() === targetName)) e.removeClass('ghost').addClass('lens-highlight'); });
        refreshRegistry();
    }

    function clearHighlights() {
        lensMode = { type: null, name: null }; cy.elements().removeClass('ghost').removeClass('lens-highlight');
        cy.nodes().forEach(n => { const baseW = n.data('type') === 'friction' ? 35 : 80; const shape = n.data('type') === 'friction' ? 'diamond' : 'ellipse'; n.style({ 'width': baseW, 'height': baseW, 'shape': shape, 'opacity': 1, 'text-opacity': 1, 'border-width': 0 }); });
        cy.edges().style({ 'line-color': '#333', 'width': 4, 'opacity': 1 }); refreshRegistry();
    }

    function refreshRegistry() {
        let html = '';
        ['characters', 'settings'].forEach(type => {
            html += `<h4 style="color:#00d4ff; margin-bottom:5px;">${type.toUpperCase()}</h4>`;
            for (let name in registry[type]) {
                const active = (lensMode.type === type && lensMode.name === name) ? 'active-lens' : '';
                html += `<div class="registry-item ${active}" onclick="applyLens('${type}', '${name}')"><strong>${name}</strong><div style="display:flex; gap:5px; margin:5px 0;" onclick="event.stopPropagation()"><input placeholder="Hybrid A" value="${registry[type][name].h1||''}" onchange="registry.${type}['${name}'].h1=this.value; refreshRegistry()"><input placeholder="Hybrid B" value="${registry[type][name].h2||''}" onchange="registry.${type}['${name}'].h2=this.value; refreshRegistry()"></div><textarea placeholder="Descriptor..." onclick="event.stopPropagation()" onchange="registry.${type}['${name}'].desc=this.value">${registry[type][name].desc||''}</textarea></div>`;
            }
        });
        document.getElementById('registry-content').innerHTML = html;
    }

    function nPos(s) { let v = parseInt(s); return v > 0 ? `rgb(0,${100+v*15},150)` : (v < 0 ? `rgb(${100+Math.abs(v)*15},30,60)` : '#444'); }
    function closeAllModals() { document.querySelectorAll('.custom-modal').forEach(m => m.style.display = 'none'); document.querySelector('.overlay').style.display = 'none'; activeNode = null; activeEdge = null; if(sourceNode) sourceNode.unselect(); sourceNode = null; }
    function exportDeep() { const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([JSON.stringify({ graph: cy.elements().jsons(), registry: registry })], { type: "application/json" })); a.download = "narrative-v40.json"; a.click(); }
    function importDeep(e) { const r = new FileReader(); r.onload=(ev)=>{ const b=JSON.parse(ev.target.result); cy.remove(cy.elements()); cy.add(b.graph); registry=b.registry; refreshRegistry(); cy.layout({name:'preset'}).run(); }; r.readAsText(e.target.files[0]); }
</script>
</body>
</html>
