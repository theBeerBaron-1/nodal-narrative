<!DOCTYPE html>
<html>
<head>
    <title>Narrative Systems Engine v7</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #0f0f0f; color: #e0e0e0; display: flex; flex-direction: column; height: 100vh; }
        #main-container { display: flex; flex-grow: 1; overflow: hidden; }
        #cy { flex-grow: 1; background: #0f0f0f; }
        #inspector { width: 340px; background: #1a1a1a; border-left: 1px solid #333; padding: 15px; overflow-y: auto; display: none; }
        #table-container { height: 280px; background: #111; border-top: 2px solid #333; overflow: auto; display: none; }
        
        .boundary-box { border: 1px solid #005f73; padding: 10px; margin: 10px 0; border-radius: 4px; background: #141e21; }
        .boundary-title { font-size: 10px; color: #00d4ff; text-transform: uppercase; margin-bottom: 5px; font-weight: bold; }
        
        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th { background: #222; position: sticky; top: 0; padding: 8px; text-align: left; border-bottom: 1px solid #444; }
        td { padding: 4px; border-bottom: 1px solid #222; }
        input, select, textarea { background: #222; border: 1px solid #444; color: #fff; width: 95%; padding: 4px; margin-bottom: 8px; }
        
        .controls { position: absolute; top: 15px; left: 15px; z-index: 999; background: #1a1a1a; padding: 10px; border-radius: 8px; border: 1px solid #333; }
        button { cursor: pointer; padding: 6px 10px; margin: 2px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px; font-size: 11px; }
        .filter-active { background: #005f73; border-color: #00d4ff; }
    </style>
</head>
<body>

<div class="controls">
    <button onclick="addNode()">+ New Scene</button>
    <button onclick="toggleTable()">Toggle Table</button>
    <select id="charFilter" onchange="filterByCharacter(this.value)" style="width: auto; margin: 0 5px;">
        <option value="">Filter by Character: All</option>
    </select>
    <button onclick="exportData()">Export</button>
    <button onclick="document.getElementById('importFile').click()">Import</button>
    <input type="file" id="importFile" style="display:none" onchange="importData(event)">
</div>

<div id="main-container">
    <div id="cy"></div>
    <div id="inspector">
        <h4 style="margin-top:0">Scene Inspector</h4>
        <div id="ins-fields"></div>
        <button style="background: #600; width:100%; margin-top:20px;" onclick="deleteNode()">Delete Scene</button>
    </div>
</div>

<div id="table-container">
    <table id="narrative-table">
        <thead>
            <tr>
                <th>Label</th><th>Score</th><th>Character</th><th>Setting</th><th>Action</th><th>Emotions</th><th>Immersion</th><th>Obstacle</th><th>Utility</th>
            </tr>
        </thead>
        <tbody id="table-body"></tbody>
    </table>
</div>

<script>
    let sourceNode = null;
    let activeNode = null;
    const Y_SCALE = 45;

    var cy = cytoscape({
        container: document.getElementById('cy'),
        style: [
            { selector: 'node', style: {
                'label': 'data(label)', 'background-color': 'data(color)', 'color': '#fff',
                'text-valign': 'center', 'width': 70, 'height': 70, 'font-size': '10px', 'text-wrap': 'wrap', 'text-max-width': '60px'
            }},
            { selector: 'edge', style: {
                'width': 3, 'line-color': '#00d4ff', 'target-arrow-shape': 'triangle', 'target-arrow-color': '#00d4ff',
                'label': 'data(action)', 'color': '#aaa', 'curve-style': 'bezier', 'font-size': '10px',
                'text-background-opacity': 1, 'text-background-color': '#0f0f0f', 'text-background-padding': '2px'
            }}
        ]
    });

    function getScoreColor(score) {
        let val = parseInt(score);
        return val > 0 ? `rgb(0, ${120+(val*13)}, 150)` : (val < 0 ? `rgb(${120+(Math.abs(val)*13)}, 30, 60)` : '#444');
    }

    function addNode() {
        const id = 'n' + Date.now();
        cy.add({
            group: 'nodes',
            data: { 
                id: id, label: "New Scene", score: 0, character: '', setting: '', 
                mainAction: '', emotions: '', immersion: '', obstacle: '', util: '', color: '#444' 
            },
            position: { x: (cy.nodes().length * 120) + 100, y: window.innerHeight/2 }
        });
        updateFilterList();
        refreshTable();
    }

    function getUnique(field) {
        let set = new Set();
        cy.nodes().forEach(n => { if(n.data(field)) set.add(n.data(field)); });
        return Array.from(set);
    }

    function updateFilterList() {
        const select = document.getElementById('charFilter');
        const current = select.value;
        select.innerHTML = '<option value="">Filter by Character: All</option>';
        getUnique('character').forEach(char => {
            select.innerHTML += `<option value="${char}" ${char === current ? 'selected' : ''}>${char}</option>`;
        });
    }

    function filterByCharacter(char) {
        if (!char) {
            cy.elements().show();
        } else {
            cy.elements().hide();
            const relevantNodes = cy.nodes().filter(n => n.data('character') === char);
            relevantNodes.show();
            relevantNodes.connectedEdges().show();
        }
        refreshTable();
    }

    cy.on('tap', 'node', function(evt){
        activeNode = evt.target;
        showInspector(activeNode);
        if (!sourceNode) { sourceNode = activeNode; activeNode.select(); } 
        else {
            if (sourceNode.id() !== activeNode.id()) {
                let act = prompt("Label for this Connection (Action/Desire):");
                cy.add({ group: 'edges', data: { id: 'e'+Date.now(), source: sourceNode.id(), target: activeNode.id(), action: act || "" } });
            }
            sourceNode.unselect(); sourceNode = null;
        }
    });

    function showInspector(node) {
        document.getElementById('inspector').style.display = 'block';
        const chars = getUnique('character');
        const sets = getUnique('setting');
        
        let html = `
            <label>LABEL</label><input value="${node.data('label')}" oninput="updateVal('${node.id()}', 'label', this.value)">
            <label>SCORE (-10 to 10)</label><input type="number" value="${node.data('score')}" oninput="updateVal('${node.id()}', 'score', this.value)">
            
            <div class="boundary-box">
                <div class="boundary-title">Participant & Locale</div>
                <label>CHARACTER</label>
                <input list="chars" value="${node.data('character')}" onchange="updateVal('${node.id()}', 'character', this.value)">
                <datalist id="chars">${chars.map(c => `<option value="${c}">`).join('')}</datalist>
                
                <label>SETTING</label>
                <input list="sets" value="${node.data('setting')}" onchange="updateVal('${node.id()}', 'setting', this.value)">
                <datalist id="sets">${sets.map(s => `<option value="${s}">`).join('')}</datalist>
            </div>

            <label>MAIN ACTION</label><input value="${node.data('mainAction')}" oninput="updateVal('${node.id()}', 'mainAction', this.value)">
            <label>EMOTIONS</label><input value="${node.data('emotions')}" oninput="updateVal('${node.id()}', 'emotions', this.value)">
            <label>IMMERSION</label><textarea oninput="updateVal('${node.id()}', 'immersion', this.value)">${node.data('immersion') || ''}</textarea>
            <label>OBSTACLE</label><input value="${node.data('obstacle')}" oninput="updateVal('${node.id()}', 'obstacle', this.value)">
            <label>UTILITY</label><textarea oninput="updateVal('${node.id()}', 'util', this.value)">${node.data('util') || ''}</textarea>
        `;
        document.getElementById('ins-fields').innerHTML = html;
    }

    function updateVal(id, field, val) {
        let n = cy.getElementById(id);
        n.data(field, val);
        if(field === 'score') {
            n.data('color', getScoreColor(val));
            n.position('y', (window.innerHeight/2) - (val * Y_SCALE));
        }
        if(field === 'character' || field === 'setting') updateFilterList();
        refreshTable();
    }

    function refreshTable() {
        const tbody = document.getElementById('table-body');
        const filterChar = document.getElementById('charFilter').value;
        tbody.innerHTML = '';
        cy.nodes().forEach(n => {
            if(filterChar && n.data('character') !== filterChar) return;
            tbody.innerHTML += `<tr>
                <td>${n.data('label')}</td><td>${n.data('score')}</td>
                <td style="color:#00d4ff">${n.data('character')}</td><td style="color:#00d4ff">${n.data('setting')}</td>
                <td>${n.data('mainAction')}</td><td>${n.data('emotions')}</td>
                <td>...</td><td>${n.data('obstacle')}</td><td>...</td>
            </tr>`;
        });
    }

    function toggleTable() { 
        let t = document.getElementById('table-container');
        t.style.display = (t.style.display === 'none') ? 'block' : 'none';
        refreshTable();
    }

    function deleteNode() { if(activeNode && confirm("Delete Scene?")) { cy.remove(activeNode); document.getElementById('inspector').style.display = 'none'; updateFilterList(); refreshTable(); } }
    function exportData() { const blob = new Blob([JSON.stringify(cy.elements().jsons())], {type:"application/json"}); const a = document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="story-system.json"; a.click(); }
    function importData(e) { const r = new FileReader(); r.onload=(ev)=>{cy.remove(cy.elements()); cy.add(JSON.parse(ev.target.result)); updateFilterList(); refreshTable();}; r.readAsText(e.target.files[0]); }
</script>
</body>
</html>
