<!DOCTYPE html>
<html>
<head>
    <title>Narrative Systems Engine v8</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #0f0f0f; color: #e0e0e0; display: flex; flex-direction: column; height: 100vh; }
        #main-container { display: flex; flex-grow: 1; overflow: hidden; position: relative; }
        #cy { flex-grow: 1; background: #0f0f0f; }
        
        /* Two Column Pop-up Inspector */
        #inspector-popup { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 700px; background: #1a1a1a; border: 2px solid #00d4ff; border-radius: 12px;
            padding: 20px; display: none; z-index: 1001; box-shadow: 0 0 30px rgba(0,0,0,0.8);
        }
        .pop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .pop-col { display: flex; flex-direction: column; }
        .boundary-section { border-bottom: 1px solid #333; margin-bottom: 10px; padding-bottom: 10px; }
        
        #table-container { height: 250px; background: #111; border-top: 2px solid #333; overflow: auto; display: none; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th { background: #222; position: sticky; top: 0; padding: 8px; text-align: left; border-bottom: 1px solid #444; }
        td { padding: 4px; border-bottom: 1px solid #222; }
        
        input, select, textarea { background: #222; border: 1px solid #444; color: #fff; width: 100%; padding: 6px; margin-top: 4px; box-sizing: border-box; }
        label { font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        
        .controls { position: absolute; top: 15px; left: 15px; z-index: 999; background: #1a1a1a; padding: 10px; border-radius: 8px; border: 1px solid #333; }
        button { cursor: pointer; padding: 6px 12px; margin: 2px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px; font-size: 11px; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; z-index: 1000; }
    </style>
</head>
<body>

<div class="overlay" onclick="closeInspector()"></div>
<div class="controls">
    <button onclick="addNode()">+ New Scene</button>
    <button onclick="toggleTable()">Toggle Table View</button>
    <button onclick="exportData()">Export</button>
</div>

<div id="main-container">
    <div id="cy"></div>
    
    <div id="inspector-popup">
        <h3 style="margin: 0 0 15px 0; color: #00d4ff;">Scene Focus</h3>
        <div class="pop-grid">
            <div class="pop-col">
                <div class="boundary-section">
                    <label>Label</label>
                    <input id="p-label" oninput="updateActiveNode()">
                    <label>Emotional Score (-10 to 10)</label>
                    <input type="number" id="p-score" oninput="updateActiveNode()">
                </div>
                <div class="boundary-section" style="border-color: #005f73;">
                    <label style="color: #00d4ff;">Participant (Character)</label>
                    <input list="p-chars" id="p-char" onchange="updateActiveNode()">
                    <datalist id="p-chars"></datalist>
                    
                    <label style="color: #00d4ff; margin-top: 10px; display: block;">Locale (Setting)</label>
                    <input list="p-sets" id="p-set" onchange="updateActiveNode()">
                    <datalist id="p-sets"></datalist>
                </div>
            </div>
            <div class="pop-col">
                <label>Main Action</label>
                <input id="p-action" oninput="updateActiveNode()">
                <label>Emotions</label>
                <input id="p-emotions" oninput="updateActiveNode()">
                <label>Immersion</label>
                <textarea id="p-immersion" rows="2" oninput="updateActiveNode()"></textarea>
                <label>Obstacle (Label)</label>
                <input id="p-obstacle" oninput="updateActiveNode()">
                <label>Utility</label>
                <textarea id="p-utility" rows="2" oninput="updateActiveNode()"></textarea>
            </div>
        </div>
        <div style="margin-top: 15px; display: flex; justify-content: space-between;">
            <button onclick="closeInspector()">Save & Close</button>
            <button style="background: #600;" onclick="deleteNode()">Delete Scene</button>
        </div>
    </div>
</div>

<div id="table-container">
    <table>
        <thead>
            <tr>
                <th>Label</th><th>Score</th><th>Char</th><th>Set</th><th>Action</th><th>Emotions</th><th>Obstacle</th>
            </tr>
        </thead>
        <tbody id="table-body"></tbody>
    </table>
</div>

<script>
    let activeNode = null;
    let sourceNode = null;
    const Y_SCALE = 50;

    var cy = cytoscape({
        container: document.getElementById('cy'),
        style: [
            { selector: 'node', style: {
                'label': 'data(label)', 'background-color': 'data(color)', 'color': '#fff',
                'text-valign': 'center', 'width': 70, 'height': 70, 'font-size': '11px', 'text-wrap': 'wrap', 'text-max-width': '60px'
            }},
            { selector: 'edge', style: {
                'width': 3, 'line-color': '#00d4ff', 'target-arrow-shape': 'triangle', 'target-arrow-color': '#00d4ff',
                'label': 'data(action)', 'color': '#aaa', 'curve-style': 'bezier', 'font-size': '10px',
                'text-background-opacity': 1, 'text-background-color': '#0f0f0f', 'text-background-padding': '2px'
            }}
        ]
    });

    function getScoreColor(score) {
        let val = parseInt(score);
        return val > 0 ? `rgb(0, ${120+(val*13)}, 150)` : (val < 0 ? `rgb(${120+(Math.abs(val)*13)}, 30, 60)` : '#444');
    }

    function addNode() {
        const id = 'n' + Date.now();
        cy.add({
            group: 'nodes',
            data: { id: id, label: "New Scene", score: 0, character:'', setting:'', mainAction:'', emotions:'', immersion:'', obstacle:'', utility:'', color: '#444' },
            position: { x: (cy.nodes().length * 150) + 100, y: window.innerHeight/2 }
        });
        refreshTable();
    }

    cy.on('tap', 'node', function(evt){
        activeNode = evt.target;
        if (!sourceNode) {
            sourceNode = activeNode;
            activeNode.select();
            // Show pop-up on single click
            openInspector(activeNode);
        } else {
            if (sourceNode.id() !== activeNode.id()) {
                let act = prompt("Connection Label:");
                cy.add({ group: 'edges', data: { id: 'e'+Date.now(), source: sourceNode.id(), target: activeNode.id(), action: act || "" } });
            }
            sourceNode.unselect(); sourceNode = null;
        }
    });

    function openInspector(node) {
        document.querySelector('.overlay').style.display = 'block';
        document.getElementById('inspector-popup').style.display = 'block';
        
        // Populate fields
        document.getElementById('p-label').value = node.data('label');
        document.getElementById('p-score').value = node.data('score');
        document.getElementById('p-char').value = node.data('character');
        document.getElementById('p-set').value = node.data('setting');
        document.getElementById('p-action').value = node.data('mainAction');
        document.getElementById('p-emotions').value = node.data('emotions');
        document.getElementById('p-immersion').value = node.data('immersion');
        document.getElementById('p-obstacle').value = node.data('obstacle');
        document.getElementById('p-utility').value = node.data('utility');

        // Update datalists for dropdowns
        updateDatalists();
    }

    function updateActiveNode() {
        if (!activeNode) return;
        const score = document.getElementById('p-score').value;
        activeNode.data({
            label: document.getElementById('p-label').value,
            score: score,
            character: document.getElementById('p-char').value,
            setting: document.getElementById('p-set').value,
            mainAction: document.getElementById('p-action').value,
            emotions: document.getElementById('p-emotions').value,
            immersion: document.getElementById('p-immersion').value,
            obstacle: document.getElementById('p-obstacle').value,
            utility: document.getElementById('p-utility').value,
            color: getScoreColor(score)
        });
        activeNode.position('y', (window.innerHeight/2) - (score * Y_SCALE));
        refreshTable();
    }

    function updateDatalists() {
        const chars = [...new Set(cy.nodes().map(n => n.data('character')).filter(x => x))];
        const sets = [...new Set(cy.nodes().map(n => n.data('setting')).filter(x => x))];
        document.getElementById('p-chars').innerHTML = chars.map(c => `<option value="${c}">`).join('');
        document.getElementById('p-sets').innerHTML = sets.map(s => `<option value="${s}">`).join('');
    }

    function closeInspector() {
        document.querySelector('.overlay').style.display = 'none';
        document.getElementById('inspector-popup').style.display = 'none';
        if(sourceNode) { sourceNode.unselect(); sourceNode = null; }
    }

    function refreshTable() {
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = '';
        cy.nodes().forEach(n => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input value="${n.data('label')}" oninput="updateFromTable('${n.id()}', 'label', this.value)"></td>
                <td><input type="number" value="${n.data('score')}" oninput="updateFromTable('${n.id()}', 'score', this.value)"></td>
                <td><input value="${n.data('character')}" oninput="updateFromTable('${n.id()}', 'character', this.value)"></td>
                <td><input value="${n.data('setting')}" oninput="updateFromTable('${n.id()}', 'setting', this.value)"></td>
                <td><input value="${n.data('mainAction')}" oninput="updateFromTable('${n.id()}', 'mainAction', this.value)"></td>
                <td><input value="${n.data('emotions')}" oninput="updateFromTable('${n.id()}', 'emotions', this.value)"></td>
                <td><input value="${n.data('obstacle')}" oninput="updateFromTable('${n.id()}', 'obstacle', this.value)"></td>
            `;
            tbody.appendChild(tr);
        });
    }

    function updateFromTable(id, field, val) {
        let n = cy.getElementById(id);
        n.data(field, val);
        if(field === 'score') {
            n.data('color', getScoreColor(val));
            n.position('y', (window.innerHeight/2) - (val * Y_SCALE));
        }
    }

    function toggleTable() { 
        let t = document.getElementById('table-container');
        t.style.display = (t.style.display === 'none') ? 'block' : 'none';
        refreshTable();
    }

    function deleteNode() { if(confirm("Delete scene?")) { cy.remove(activeNode); closeInspector(); refreshTable(); } }
    function exportData() { /* Standard Blob Export logic */ }
</script>
</body>
</html>
