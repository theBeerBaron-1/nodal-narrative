<!DOCTYPE html>
<html>
<head>
    <title>Narrative Systems Engine v15</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #0f0f0f; color: #e0e0e0; display: flex; height: 100vh; overflow: hidden; }
        #main-wrapper { display: flex; flex-grow: 1; flex-direction: column; position: relative; }
        #cy { flex-grow: 1; background: #0f0f0f; }
        #registry-panel { width: 380px; background: #151515; border-left: 1px solid #333; padding: 20px; overflow-y: auto; }
        .registry-header { color: #00d4ff; border-bottom: 1px solid #333; cursor: pointer; display: flex; justify-content: space-between; padding: 5px 0; font-weight: bold; }
        .registry-item { background: #222; padding: 12px; border-radius: 6px; margin-top: 10px; border-left: 4px solid #00d4ff; }
        #inspector-popup { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 850px; background: #1a1a1a; border: 2px solid #00d4ff; border-radius: 12px; padding: 25px; display: none; z-index: 1001; box-shadow: 0 0 60px rgba(0,0,0,1); }
        .pop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .controls { position: absolute; top: 15px; left: 15px; z-index: 999; background: #1a1a1a; padding: 12px; border-radius: 8px; border: 1px solid #333; }
        input, textarea, select { background: #222; border: 1px solid #444; color: #fff; width: 100%; padding: 8px; margin-top: 5px; border-radius: 4px; font-family: inherit; }
        label { font-size: 11px; color: #888; text-transform: uppercase; font-weight: bold; display: block; margin-top: 12px; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; z-index: 1000; }
    </style>
</head>
<body>

<div class="overlay" onclick="closeInspector()"></div>

<div id="main-wrapper">
    <div class="controls">
        <button onclick="addNode()">+ New Scene</button>
        <button onclick="exportAll()">Export JSON</button>
        <button onclick="document.getElementById('importFile').click()">Import JSON</button>
        <input type="file" id="importFile" style="display:none" onchange="importAll(event)">
    </div>
    <div id="cy"></div>

    <div id="inspector-popup">
        <h3 style="margin: 0 0 15px 0; color: #00d4ff;">SCENE FOCUS</h3>
        <div class="pop-grid">
            <div>
                <label>Scene Label</label><input id="p-label" oninput="updateActiveNode(false)">
                <label>Score (-10 to 10)</label><input type="number" id="p-score" oninput="updateActiveNode(false)">
                <div style="border: 1px solid #005f73; padding: 12px; margin-top: 15px; border-radius: 8px;">
                    <label>Characters</label><input id="p-char" placeholder="Alpha, Beta" onchange="updateActiveNode(true)">
                    <label>Setting</label><input id="p-set" placeholder="Forest, Castle" onchange="updateActiveNode(true)">
                </div>
            </div>
            <div>
                <label>Main Action</label>
                <input list="list-actions" id="p-action" oninput="updateActiveNode(false)" placeholder="Select or type action...">
                <label>Emotions</label>
                <input list="list-emotions" id="p-emotions" oninput="updateActiveNode(false)" placeholder="Select or type emotion...">
                <label>Immersion (Environment)</label>
                <input list="list-immersion" id="p-immersion" oninput="updateActiveNode(false)" placeholder="Select sensory anchor...">
                <label>Obstacle</label><input id="p-obstacle" oninput="updateActiveNode(false)">
                <label>Utility</label><textarea id="p-utility" rows="2" oninput="updateActiveNode(false)"></textarea>
            </div>
        </div>
        <button style="margin-top: 25px; width: 100%; padding: 12px; background: #005f73; border:none; color:white; font-weight:bold;" onclick="closeInspector()">Save & Return</button>
    </div>
</div>

<div id="registry-panel">
    <h3 style="color: #00d4ff; margin-top: 0;">World Registry</h3>
    <div id="registry-content"></div>
</div>

<datalist id="list-actions">
    <option value="Confronts"> <option value="Betrays"> <option value="Escapes"> <option value="Discovers"> <option value="Negotiates"> <option value="Infiltrates"> <option value="Rescues"> <option value="Sacrifices"> <option value="Sabotages"> <option value="Ambushes">
    <option value="Interrogates"> <option value="Eavesdrops"> <option value="Challenges"> <option value="Defends"> <option value="Attacks"> <option value="Pursues"> <option value="Deceives"> <option value="Confesses"> <option value="Forgives"> <option value="Threatens">
    <option value="Observes"> <option value="Instructs"> <option value="Consults"> <option value="Provokes"> <option value="Surrenders"> <option value="Heals"> <option value="Destroys"> <option value="Steals"> <option value="Explores"> <option value="Deciphers">
</datalist>

<datalist id="list-emotions">
    <option value="Melancholy"> <option value="Euphoria"> <option value="Resentment"> <option value="Dread"> <option value="Anticipation"> <option value="Bitterness"> <option value="Nostalgia"> <option value="Confusion"> <option value="Envy"> <option value="Rage">
    <option value="Despair"> <option value="Awe"> <option value="Shame"> <option value="Guilt"> <option value="Solitude"> <option value="Hope"> <option value="Terror"> <option value="Gratitude"> <option value="Contempt"> <option value="Apathy">
</datalist>

<datalist id="list-immersion">
    <option value="Sulphurous"> <option value="Bleached"> <option value="Rot-sweet"> <option value="Airless"> <option value="Bramble-choked"> 
    <option value="Luminous"> <option value="Oil-smeared"> <option value="Verdant"> <option value="Sun-cracked"> <option value="Weatherworn"> 
    <option value="Crowded"> <option value="Lead-heavy"> <option value="Echoing"> <option value="Body-warm"> <option value="Maze-like"> 
    <option value="Briny"> <option value="Neon-soaked"> <option value="Dust-caked"> <option value="Piston-rhythmed"> <option value="Glass-fragile"> 
    <option value="Clammy"> <option value="Ash-drifted"> <option value="Resonant"> <option value="Muffled"> <option value="Gleaming"> 
    <option value="Hushed"> <option value="Rancid"> <option value="Wind-scoured"> <option value="Slick"> <option value="Pulse-thick"> 
    <option value="Smoke-choked"> <option value="Frost-bitten"> <option value="Heat-warped"> <option value="Velvet-dark"> <option value="Jagged"> 
    <option value="Rain-sodden"> <option value="Brittle"> <option value="Backlit"> <option value="Throat-rough"> <option value="Whispering"> 
    <option value="Iron-tanged"> <option value="Pulsing"> <option value="Dank"> <option value="Shuddering"> <option value="Hollow"> 
    <option value="Smouldering"> <option value="Film-skinned"> <option value="Pressurised"> <option value="Footstep-loud"> <option value="Tart"> 
    <option value="Prickling"> <option value="Fizzy"> <option value="Trembling"> <option value="Crisp"> <option value="Fragrant"> 
    <option value="Metallic"> <option value="Gravelly"> <option value="Sticky"> <option value="Glistening"> <option value="Clattering">
</datalist>

<script>
    let activeNode = null;
    let sourceNode = null;
    let registry = { characters: {}, settings: {} };
    let lastX = 100;

    var cy = cytoscape({
        container: document.getElementById('cy'),
        style: [
            { selector: 'node', style: { 'label': 'data(label)', 'background-color': 'data(color)', 'color': '#fff', 'text-valign': 'center', 'width': 75, 'height': 75, 'font-size': '10px', 'text-wrap': 'wrap', 'text-max-width': '60px' }},
            { selector: 'edge', style: { 'width': 4, 'line-color': '#333', 'target-arrow-shape': 'triangle', 'label': 'data(action)', 'color': '#00d4ff', 'curve-style': 'bezier', 'font-size': '11px', 'text-background-opacity': 1, 'text-background-color': '#0f0f0f' }}
        ]
    });

    function addNode() {
        const id = 'n' + Date.now();
        const newX = lastX + 180;
        const newY = (window.innerHeight / 2) + (Math.random() * 40 - 20);
        cy.add({ group: 'nodes', data: { id: id, label: "New Scene", score: 0, color: '#444', characters: [], settings: [] }, position: { x: newX, y: newY } });
        lastX = newX;
    }

    cy.on('tap', 'node', function(evt){
        let n = evt.target;
        if (!sourceNode) { sourceNode = n; n.select(); } 
        else {
            if (sourceNode.id() === n.id()) { openInspector(n); } 
            else {
                let act = prompt("Connection Action:");
                if (act) cy.add({ group: 'edges', data: { source: sourceNode.id(), target: n.id(), action: act } });
            }
            sourceNode.unselect(); sourceNode = null;
        }
    });

    function openInspector(node) {
        activeNode = node;
        document.querySelector('.overlay').style.display = 'block';
        document.getElementById('inspector-popup').style.display = 'block';
        const d = node.data();
        document.getElementById('p-label').value = d.label || '';
        document.getElementById('p-score').value = d.score || 0;
        document.getElementById('p-char').value = (d.characters || []).join(', ');
        document.getElementById('p-set').value = (d.settings || []).join(', ');
        document.getElementById('p-action').value = d.mainAction || '';
        document.getElementById('p-emotions').value = d.emotions || '';
        document.getElementById('p-immersion').value = d.immersion || '';
        document.getElementById('p-obstacle').value = d.obstacle || '';
        document.getElementById('p-utility').value = d.utility || '';
    }

    function updateActiveNode(updateRegistry) {
        if (!activeNode) return;
        const chars = document.getElementById('p-char').value.split(',').map(s => s.trim()).filter(s => s);
        const sets = document.getElementById('p-set').value.split(',').map(s => s.trim()).filter(s => s);
        const score = document.getElementById('p-score').value;

        activeNode.data({
            label: document.getElementById('p-label').value,
            score: score,
            characters: chars,
            settings: sets,
            mainAction: document.getElementById('p-action').value,
            emotions: document.getElementById('p-emotions').value,
            immersion: document.getElementById('p-immersion').value,
            obstacle: document.getElementById('p-obstacle').value,
            utility: document.getElementById('p-utility').value,
            color: nPos(score)
        });
        
        activeNode.position('y', (window.innerHeight/2) - (score * 50));
        
        if (updateRegistry) {
            chars.forEach(c => { if(!registry.characters[c]) registry.characters[c] = { desc: '', link: '' }; });
            sets.forEach(s => { if(!registry.settings[s]) registry.settings[s] = { desc: '', link: '' }; });
            updateRegistryPanel();
        }
    }

    function nPos(s) { let v = parseInt(s); return v > 0 ? `rgb(0,${100+v*15},150)` : (v < 0 ? `rgb(${100+Math.abs(v)*15},30,60)` : '#444'); }

    function updateRegistryPanel() {
        let html = '';
        ['characters', 'settings'].forEach(type => {
            html += `<div class="registry-section">
                <div class="registry-header" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'">
                    <span>${type.toUpperCase()}</span><span>â–¼</span>
                </div>
                <div>`;
            for (let name in registry[type]) {
                html += `<div class="registry-item"><strong>${name}</strong><textarea placeholder="Description..." onchange="registry.${type}['${name}'].desc=this.value">${registry[type][name].desc || ''}</textarea></div>`;
            }
            html += `</div></div>`;
        });
        document.getElementById('registry-content').innerHTML = html;
    }

    function closeInspector() { 
        updateActiveNode(true);
        document.querySelector('.overlay').style.display = 'none'; 
        document.getElementById('inspector-popup').style.display = 'none'; 
        activeNode = null; 
    }

    function exportAll() {
        const bundle = { graph: cy.elements().jsons(), registry: registry, lastX: lastX };
        const a = document.createElement("a");
        a.href = URL.createObjectURL(new Blob([JSON.stringify(bundle)], { type: "application/json" }));
        a.download = "narrative-polymath-v15.json";
        a.click();
    }

    function importAll(event) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const bundle = JSON.parse(e.target.result);
            cy.remove(cy.elements());
            cy.add(bundle.graph);
            registry = bundle.registry || { characters: {}, settings: {} };
            lastX = bundle.lastX || 100;
            updateRegistryPanel();
            cy.layout({ name: 'preset' }).run();
        };
        reader.readAsText(event.target.files[0]);
    }
</script>
</body>
</html>
