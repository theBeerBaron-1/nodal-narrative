<!DOCTYPE html>
<html>
<head>
    <title>Narrative Systems Engine v4</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #0f0f0f; color: #e0e0e0; }
        #cy { width: 100vw; height: 100vh; display: block; }
        .controls { position: absolute; top: 15px; left: 15px; z-index: 999; background: #1a1a1a; padding: 15px; border-radius: 8px; border: 1px solid #333; }
        button { cursor: pointer; padding: 6px 10px; margin: 2px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px; font-size: 11px; }
        button:hover { border-color: #00d4ff; }
        .import-export { margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #333; }
        .hint { font-size: 0.7em; color: #777; margin-top: 8px; }
    </style>
</head>
<body>

<div class="controls">
    <div class="import-export">
        <button onclick="exportData()">Export JSON</button>
        <button onclick="document.getElementById('importFile').click()">Import JSON</button>
        <input type="file" id="importFile" style="display:none" onchange="importData(event)">
    </div>
    <button onclick="addNode()">+ New Scene</button>
    <div class="hint">
        • Y-axis is locked to Emotional Score (-10 to 10).<br>
        • Click nodes to edit/delete or connect.<br>
        • Click lines to split.
    </div>
</div>
<div id="cy"></div>

<script>
    let sourceNode = null;
    const Y_SCALE = 40; // Pixels per score point

    var cy = cytoscape({
        container: document.getElementById('cy'),
        style: [
            {
                selector: 'node',
                style: {
                    'label': 'data(label)',
                    'background-color': 'data(color)',
                    'color': '#fff',
                    'text-valign': 'center',
                    'text-halign': 'center',
                    'width': 80,
                    'height': 80,
                    'font-size': '10px',
                    'text-wrap': 'wrap',
                    'text-max-width': '70px'
                }
            },
            {
                selector: 'edge',
                style: {
                    'width': 2,
                    'line-color': '#444',
                    'target-arrow-shape': 'triangle',
                    'curve-style': 'bezier',
                    'label': 'data(action)',
                    'color': '#888',
                    'font-size': '9px'
                }
            }
        ]
    });

    function getScoreColor(score) {
        let val = parseInt(score);
        if (val > 0) return `rgb(0, ${120 + (val * 13)}, 150)`;
        if (val < 0) return `rgb(${120 + (Math.abs(val) * 13)}, 30, 60)`;
        return '#444';
    }

    function addNode(existingData = null) {
        let data = existingData;
        
        if (!data) {
            let label = prompt("Scene Label:", "New Scene");
            let score = prompt("Emotional Score (-10 to 10):", "0");
            if (label === null || score === null) return;
            
            data = {
                id: 'n' + Date.now(),
                label: label,
                score: parseInt(score),
                setting: prompt("Setting/Location:"),
                character: prompt("Primary Character:"),
                action: prompt("Main Action:"),
                immersion: prompt("Immersion Detail:"),
                obstacle: prompt("Obstacle/Conflict:"),
                utility: prompt("Utility of Scene:")
            };
        }

        // Calculate Y based on score (Center is 0, negative is down, positive is up)
        const yPos = (window.innerHeight / 2) - (data.score * Y_SCALE);
        const xPos = existingData ? existingData.x : (cy.nodes().length * 150) + 100;

        cy.add({
            group: 'nodes',
            data: { 
                ...data, 
                label: `${data.label}\n[${data.score}]\nLoc: ${data.setting}`,
                color: getScoreColor(data.score) 
            },
            position: { x: xPos, y: yPos }
        });
    }

    // Connect & Edit Logic
    cy.on('tap', 'node', function(evt){
        let node = evt.target;
        if (!sourceNode) {
            sourceNode = node;
            node.select();
            setTimeout(() => {
                if (confirm("Edit details or Delete?")) {
                    let choice = prompt("Type 'E' to Edit, 'D' to Delete:");
                    if (choice?.toUpperCase() === 'E') {
                        let newScore = prompt("New Score:", node.data('score'));
                        node.data('score', newScore);
                        node.position('y', (window.innerHeight / 2) - (newScore * Y_SCALE));
                        node.data('color', getScoreColor(newScore));
                    } else if (choice?.toUpperCase() === 'D') {
                        cy.remove(node);
                    }
                    sourceNode = null;
                    node.unselect();
                }
            }, 300);
        } else {
            if (sourceNode.id() !== node.id()) {
                let action = prompt("Action connecting them:");
                cy.add({ group: 'edges', data: { id: 'e' + Date.now(), source: sourceNode.id(), target: node.id(), action: action || "" } });
            }
            sourceNode.unselect();
            sourceNode = null;
        }
    });

    // Split Edge
    cy.on('tap', 'edge', function(evt){
        let edge = evt.target;
        if (confirm("Split this action?")) {
            addNode();
            // User can then manually connect the new node to the two ends. 
            // Simplified for reliability: click-to-connect is more robust here.
        }
    });

    function exportData() {
        const json = JSON.stringify(cy.elements().jsons());
        const blob = new Blob([json], { type: "application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "narrative-system.json";
        a.click();
    }

    function importData(event) {
        const reader = new FileReader();
        reader.onload = function(e) {
            cy.remove(cy.elements());
            const elements = JSON.parse(e.target.result);
            cy.add(elements);
            cy.layout({ name: 'preset' }).run();
        };
        reader.readAsText(event.target.files[0]);
    }
</script>
</body>
</html>
