<!DOCTYPE html>
<html>
<head>
    <title>Narrative Systems Engine v5</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #0f0f0f; color: #e0e0e0; display: flex; }
        #cy { flex-grow: 1; height: 100vh; background: #0f0f0f; }
        #inspector { width: 300px; background: #1a1a1a; border-left: 1px solid #333; padding: 20px; overflow-y: auto; display: none; }
        .controls { position: absolute; top: 15px; left: 15px; z-index: 999; background: #1a1a1a; padding: 15px; border-radius: 8px; border: 1px solid #333; }
        button { cursor: pointer; padding: 6px 10px; margin: 2px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px; font-size: 11px; }
        button:hover { border-color: #00d4ff; }
        input, textarea { width: 100%; background: #222; border: 1px solid #444; color: #fff; margin-bottom: 10px; padding: 5px; }
        label { font-size: 0.8em; color: #888; }
    </style>
</head>
<body>

<div class="controls">
    <button onclick="addNode()">+ New Scene</button>
    <button onclick="exportData()">Export</button>
    <button onclick="document.getElementById('importFile').click()">Import</button>
    <input type="file" id="importFile" style="display:none" onchange="importData(event)">
    <hr style="border:0; border-top:1px solid #333;">
    <button onclick="toggleAxis('score')">Y = Emotional Score</button>
    <button onclick="toggleAxis('obstacle')">Y = Obstacle Difficulty</button>
</div>

<div id="cy"></div>

<div id="inspector">
    <h3 id="ins-title">Scene Details</h3>
    <label>Label</label><input id="ins-label" oninput="updateNode()">
    <label>Score (-10 to 10)</label><input type="number" id="ins-score" oninput="updateNode()">
    <label>Obstacle Difficulty (1-10)</label><input type="number" id="ins-obs-val" oninput="updateNode()">
    <hr>
    <label>Setting</label><input id="ins-setting" oninput="updateNode()">
    <label>Character</label><input id="ins-char" oninput="updateNode()">
    <label>Obstacle Description</label><textarea id="ins-obs-desc" oninput="updateNode()"></textarea>
    <label>Utility</label><textarea id="ins-util" oninput="updateNode()"></textarea>
    <button style="background:#600" onclick="deleteNode()">Delete Node</button>
</div>

<script>
    let sourceNode = null;
    let activeNode = null;
    const Y_SCALE = 40;

    var cy = cytoscape({
        container: document.getElementById('cy'),
        style: [
            { selector: 'node', style: {
                'label': 'data(label)', 'background-color': 'data(color)', 'color': '#fff',
                'text-valign': 'center', 'width': 60, 'height': 60, 'font-size': '10px'
            }},
            { selector: 'edge', style: {
                'width': 2, 'line-color': '#444', 'target-arrow-shape': 'triangle', 'label': 'data(action)', 'color': '#888', 'curve-style': 'bezier'
            }}
        ]
    });

    function getScoreColor(score) {
        let val = parseInt(score);
        return val > 0 ? `rgb(0, ${120+(val*13)}, 150)` : (val < 0 ? `rgb(${120+(Math.abs(val)*13)}, 30, 60)` : '#444');
    }

    function addNode() {
        let label = prompt("Scene Label:", "New Scene");
        let score = prompt("Score (-10 to 10):", "0");
        if (label === null || score === null) return;
        
        let id = 'n' + Date.now();
        cy.add({
            group: 'nodes',
            data: { 
                id: id, label: label, score: parseInt(score), obstacleVal: 0,
                setting: '', character: '', obsDesc: '', util: '', color: getScoreColor(score) 
            },
            position: { x: (cy.nodes().length * 100) + 50, y: (window.innerHeight/2) - (score * Y_SCALE) }
        });
    }

    cy.on('tap', 'node', function(evt){
        let node = evt.target;
        activeNode = node;
        showInspector(node);

        if (!sourceNode) {
            sourceNode = node;
        } else {
            if (sourceNode.id() !== node.id()) {
                let action = prompt("Action/Desire:");
                cy.add({ group: 'edges', data: { id: 'e'+Date.now(), source: sourceNode.id(), target: node.id(), action: action || "" } });
            }
            sourceNode = null;
        }
    });

    function showInspector(node) {
        document.getElementById('inspector').style.display = 'block';
        document.getElementById('ins-label').value = node.data('label');
        document.getElementById('ins-score').value = node.data('score');
        document.getElementById('ins-obs-val').value = node.data('obstacleVal') || 0;
        document.getElementById('ins-setting').value = node.data('setting') || '';
        document.getElementById('ins-char').value = node.data('character') || '';
        document.getElementById('ins-obs-desc').value = node.data('obsDesc') || '';
        document.getElementById('ins-util').value = node.data('util') || '';
    }

    function updateNode() {
        if (!activeNode) return;
        let s = document.getElementById('ins-score').value;
        activeNode.data({
            label: document.getElementById('ins-label').value,
            score: s,
            obstacleVal: document.getElementById('ins-obs-val').value,
            setting: document.getElementById('ins-setting').value,
            character: document.getElementById('ins-char').value,
            obsDesc: document.getElementById('ins-obs-desc').value,
            util: document.getElementById('ins-util').value,
            color: getScoreColor(s)
        });
        activeNode.position('y', (window.innerHeight/2) - (s * Y_SCALE));
    }

    function toggleAxis(type) {
        cy.nodes().forEach(n => {
            let val = type === 'score' ? n.data('score') : n.data('obstacleVal');
            n.animate({ position: { y: (window.innerHeight/2) - (val * Y_SCALE) } });
        });
    }

    function deleteNode() { if(activeNode && confirm("Delete?")) { cy.remove(activeNode); document.getElementById('inspector').style.display = 'none'; } }
    function exportData() { /* Same as previous turns */ }
    function importData(event) { /* Same as previous turns */ }
</script>
</body>
</html>
